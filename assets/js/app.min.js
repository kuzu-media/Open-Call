/*jshint devel:true */
/*global angular */

var OpenCall = angular.module("OpenCall", ["firebase"]);

OpenCall.run(['angularFireAuth',"FIREBASE_URL","firebaseRefManager","$rootScope",function(angularFireAuth,FIREBASE_URL,firebaseRefManager,$rootScope)
{
	var firbase_ref = firebaseRefManager(FIREBASE_URL);
	angularFireAuth.initialize(firbase_ref,{'scope': $rootScope,'name':'user','path':'/welcome'});
}]);

OpenCall.constant("FIREBASE_URL","https://opencall.firebaseio.com/");


OpenCall.directive('ngBlur', function() {
  return function( scope, elem, attrs ) {
    elem.bind('blur', function() {
      scope.$apply(attrs.ngBlur);
    });
  };
});

/* **********************************************
     Begin routes.js
********************************************** */

/*global OpenCall */
OpenCall.config(function($routeProvider)
{
	$routeProvider
	.when("/",{
		templateUrl: 'app/views/events.html',
		controller: "Events",
		authRequired: true
	})
	.when("/welcome",{
		templateUrl: 'app/views/welcome.html',
		controller: "User",
		authRequired: false
	})
	.when("/join",{
		templateUrl: 'app/views/join.html',
		controller: "User",
		authRequired: false
	})
	.when("/login",{
		templateUrl: 'app/views/login.html',
		controller: "User",
		authRequired: false
	});
});

/* **********************************************
     Begin angularFireCollectionExtended.min.js
********************************************** */

/* Extends AngularFireCollection to better handle collections and add extra functionality *//* global angular */angular.module("firebase").factory("firebaseRefManager",["Firebase",function(e){var t={};return function(n){t[n]||(t[n]=new e(n));return t[n]}}]);angular.module("firebase").factory("angularFireCollectionExtended",["$q","angularFireCollection","$timeout","firebaseRefManager",function(e,t,n,r){var i={},s=function(i){var s={data:[],"private":{deferred:e.defer()}};s.private.promise=s.private.deferred.promise;var o=function(){n(function(){s.data.length>0?s.private.deferred.resolve(s.data):o()})};s.data=t(r(i),function(e){e.val()===null?s.private.deferred.resolve(s.data):o()});s.data.getByKey=function(e,t){for(var n=0,r=s.data.length;n<r;n++)if(s.data[n][e]===t)return s.data[n];return!1};return s};return function(e,t){i[e]||(i[e]=new s(e));typeof t!="undefined"&&(i[e].private.timeout=t);return i[e].private.promise}}]);

/* **********************************************
     Begin User.js
********************************************** */

/*global OpenCall */
/*jshint devel:true */


OpenCall.controller("User",['$scope','$location','angularFireAuth','angularFireCollectionExtended','FIREBASE_URL',function($scope,$location,angularFireAuth,angularFireCollectionExtended,FIREBASE_URL)
{
	$scope.login = function()
	{
		// pass the user
		angularFireAuth.login("password",$scope.user).then(function()
		{
			$location.path("/");
		});
	};

	$scope.logout = function()
	{
		angularFireAuth.logout();

	};

	$scope.create_user = function()
	{
		console.log('hello');
		// create the user
		angularFireAuth.createUser($scope.new_user.email,$scope.new_user.password,function(err,user){
			console.log('user',user);
			if(user)
			{
				angularFireCollectionExtended(FIREBASE_URL+"users").then(function(users)
				{
					users.add({
						id: user.id,
						first_name: $scope.new_user.first_name,
						last_name: $scope.new_user.last_name
					});

				});


				$location.path("/");
			}
		});
	};

	// validate that the password and confirm password match
	$scope.validatePassword = function()
	{
		// set the not matching error if the passwords don't match
		$scope.join_form.confirm.$error.notMatching = $scope.new_user.password !== $scope.new_user.confirm;
	};

	$scope.$on("angularFireAuth:error", function(evt, err) {
		console.log('err',err);
	});

	$scope.$on("angularFireAuth:logout", function() {
		$location.path("/welcome");
	});
}]);

/* **********************************************
     Begin Events.js
********************************************** */

/* global OpenCall */
OpenCall.controller("Events",[function()
{

}
]);