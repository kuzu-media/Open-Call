/*jshint devel:true */
/*global angular */

var OpenCall = angular.module("OpenCall", ["firebase","ui.bootstrap"]);

OpenCall.run(['angularFireAuth',"FIREBASE_URL","firebaseRefManager","$rootScope",'$route',function(angularFireAuth,FIREBASE_URL,firebaseRefManager,$rootScope, $route)
{
	var firbase_ref = firebaseRefManager(FIREBASE_URL);
	angularFireAuth.initialize(firbase_ref,{'scope': $rootScope,'name':'user','path':'/welcome'});

	$rootScope.page_title = 'Welcome';
	$rootScope.$on('$routeChangeSuccess', function() {
		$rootScope.page_title = $route.current.title;
	});
}]);

OpenCall.constant("FIREBASE_URL","https://opencall.firebaseio.com/");


OpenCall.directive('ngBlur', function() {
  return function( scope, elem, attrs ) {
    elem.bind('blur', function() {
      scope.$apply(attrs.ngBlur);
    });
  };
});

/* **********************************************
     Begin routes.js
********************************************** */

/*global OpenCall */
OpenCall.config(function($routeProvider)
{
	$routeProvider
	.when("/",{
		templateUrl: 'app/views/events.html',
		controller: "Events",
		authRequired: true,
		title: 'Events'
	})
	.when("/events/:event_id",{
		templateUrl: 'app/views/event.html',
		controller: "Events",
		authRequired: true,
		title: ''
	})
	.when("/welcome",{
		templateUrl: 'app/views/welcome.html',
		controller: "User",
		authRequired: false,
		title: 'Welcome'
	})
	.when("/join",{
		templateUrl: 'app/views/join.html',
		controller: "User",
		authRequired: false,
		title: 'Join'
	})
	.when("/login",{
		templateUrl: 'app/views/login.html',
		controller: "User",
		authRequired: false,
		title: 'Login'
	}).when("/create",{
		templateUrl: 'app/views/create.html',
		controller: "Events",
		authRequired: true,
		title: 'Create an Event'
	})
	.when("/admin",{
		templateUrl:'app/views/admin.html',
		controller: 'Admin',
		authRequired: true,
		title: 'Admin'
	})
	.when("/notifications",{
		templateUrl:'app/views/notifications.html',
		controller: 'Notifications',
		authRequired: true,
		title: 'Notifications'
	});
});

/* **********************************************
     Begin partials.js
********************************************** */

/*global OpenCall*/
OpenCall.directive("navbar",function()
{
	return {
		restrict: "E",
		templateUrl: "app/views/partials/navbar.html"
	};
});

OpenCall.directive('backButton', function(){
	return {
		restrict: 'A',

		link: function(scope, element) {

			element.bind('click', function () {
				history.back();
				scope.$apply();
			});


		}
	};
});


/* **********************************************
     Begin angularFireCollectionExtended.min.js
********************************************** */

/* Extends AngularFireCollection to better handle collections and add extra functionality *//* global angular */angular.module("firebase").factory("firebaseRefManager",["Firebase",function(e){var t={};return function(n){t[n]||(t[n]=new e(n));return t[n]}}]);angular.module("firebase").factory("angularFireCollectionExtended",["$q","angularFireCollection","$timeout","firebaseRefManager",function(e,t,n,r){var i={},s=function(i){var s={data:[],"private":{deferred:e.defer()}};s.private.promise=s.private.deferred.promise;var o=function(){n(function(){s.data.length>0?s.private.deferred.resolve(s.data):o()})};s.data=t(r(i),function(e){e.val()===null?s.private.deferred.resolve(s.data):o()});s.data.getByKey=function(e,t){for(var n=0,r=s.data.length;n<r;n++)if(s.data[n][e]===t)return s.data[n];return!1};return s};return function(e,t){i[e]||(i[e]=new s(e));typeof t!="undefined"&&(i[e].private.timeout=t);return i[e].private.promise}}]);

/* **********************************************
     Begin User.js
********************************************** */

/*global OpenCall */
/*jshint devel:true */

OpenCall.controller("User",['$scope','$rootScope','$location','angularFireAuth','angularFire','firebaseRefManager','FIREBASE_URL',function($scope,$rootScope,$location,angularFireAuth,angularFire,firebaseRefManager,FIREBASE_URL)
{
	$scope.login = function()
	{
		// pass the user
		angularFireAuth.login("password",$scope.user).then(function()
		{
			$location.path("/");
		});
	};

	$scope.logout = function()
	{
		angularFireAuth.logout();

	};

	$scope.create_user = function()
	{
		// create the user
		angularFireAuth.createUser($scope.new_user.email,$scope.new_user.password,function(err,user){
			if(user)
			{
				$scope.users = {};
				angularFire(firebaseRefManager(FIREBASE_URL+"users"),$scope, 'users').then(function(){});

				$scope.users[user.id] = {
					first_name: $scope.new_user.first_name,
					last_name: $scope.new_user.last_name
				};

				console.log('$scope.users',$scope.users);


				$location.path("/");
			}
		});
	};

	// validate that the password and confirm password match
	$scope.validatePassword = function()
	{
		// set the not matching error if the passwords don't match
		$scope.join_form.confirm.$error.notMatching = $scope.new_user.password !== $scope.new_user.confirm;
	};

	$scope.$on("angularFireAuth:error", function(evt, err) {
		console.log('err',err);
	});

	$scope.$on("angularFireAuth:logout", function() {
		$scope.name = null;
		$location.path("/welcome");
		$rootScope.logged_in = false;

	});

	$scope.$on("angularFireAuth:login", function() {

		angularFire(firebaseRefManager(FIREBASE_URL+"users").child($rootScope.user.id), $rootScope, 'user');
	});
}]);

/* **********************************************
     Begin Events.js
********************************************** */

/* global OpenCall */
/*jshint devel:true */

OpenCall.controller("Events",['angularFire','firebaseRefManager','FIREBASE_URL','$scope','$filter','$routeParams','$rootScope','$location',function(angularFire,firebaseRefManager,FIREBASE_URL,$scope,$filter,$routeParams,$rootScope,$location)
{
	$scope.subcategories = {};
	$scope.events = {};
	var events_ref = firebaseRefManager(FIREBASE_URL+"events");
	angularFire(firebaseRefManager(FIREBASE_URL+"categories/sub"), $scope, 'subcategories');
	angularFire(events_ref,$scope,"events").then(function()
	{
		if($routeParams.event_id)
		{
			$scope.event = $scope.events[$routeParams.event_id];
			$scope.event.id = $routeParams.event_id;
			$rootScope.page_title = $scope.event.title;
		}
	});

	$scope.create = function()
	{
		$scope.event.attendee_count = 0;
		$scope.event.host = {};
		$scope.event.host.name = $rootScope.user.first_name + " " + $rootScope.user.last_name;
		$scope.event.host.id = $rootScope.user.id;
		$scope.events[events_ref.push().name()] = $scope.event;
		$scope.event = {};
		$location.path('/');
	};

	$scope.join = function()
	{
		if(typeof $scope.event.requests === "undefined")
		{
			$scope.event.requests = [];
		}
		$scope.event.requests.push($rootScope.user.id);

		angularFire(firebaseRefManager(FIREBASE_URL+"users/"+$scope.event.host.id),$scope,'host').then(function()
		{
			if(!$scope.host.notification_count){$scope.host.notification_count = 0;}
			$scope.host.notification_count++;
		});
		$scope.notifications = {};
		var not_ref = firebaseRefManager(FIREBASE_URL+"notifications/"+$scope.event.host.id);
		angularFire(not_ref,$scope,'notifications');

		var not = {
				type: 1,
				event_id: $scope.event.id,
				user_id: $rootScope.user.id
			};
		$scope.notifications[not_ref.push().name()] = not;
	};
}
]);

/* **********************************************
     Begin Admin.js
********************************************** */

/*global OpenCall */
/*jshint devel:true */

OpenCall.controller("Admin",['$scope','$rootScope','$location','angularFireAuth','angularFire','firebaseRefManager','FIREBASE_URL',function($scope,$rootScope,$location,angularFireAuth,angularFire,firebaseRefManager,FIREBASE_URL)
{
		$scope.categories = {};
		$scope.subcategories = {};

		var cat_ref = firebaseRefManager(FIREBASE_URL+"categories/top");
		var sub_ref = firebaseRefManager(FIREBASE_URL+"categories/sub");

		angularFire(cat_ref, $scope,'categories');
		angularFire(sub_ref, $scope,'subcategories');

		$scope.create_cat = function()
		{
			$scope.categories[cat_ref.push().name()] = $scope.category;
			$scope.category = {};
		};

		$scope.create_subcat = function()
		{
			console.log('$scope.categories',$scope.categories);
			$scope.subcategories[sub_ref.push().name()] = angular.copy($scope.sub);
			$scope.sub.name = "";

		};

		$scope.delete = function(id)
		{
			console.log('id',id, $scope.subcategories);
			$scope.subcategories[id] = null;
		};
}]);

/* **********************************************
     Begin Notifications.js
********************************************** */

/* global OpenCall */
/*jshint devel:true */

OpenCall.controller("Notifications",['FIREBASE_URL','$rootScope','angularFireCollectionExtended','$scope',function(FIREBASE_URL,$rootScope,angularFireCollectionExtended,$scope)
{
	if(!$rootScope.user_info)
	{
		angularFireCollectionExtended(FIREBASE_URL+"users").then(function(users)
		{
			$rootScope.user_info = users.getByKey('id',$rootScope.user.id);
		});
	}
	angularFireCollectionExtended(FIREBASE_URL+"notifications/"+$rootScope.user_info.$id).then(function(notifications)
	{
		$scope.notifcations = notifications;
	});
}]);